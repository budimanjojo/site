<!DOCTYPE html>


  
<html itemscope itemtype="https://schema.org/WebPage" class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="siteBaseUrl" content="https://budimanjojo.com">
    <meta name="author" content="budimanjojo">
    <meta name="description" content="Life Journey of My Geeky Needs.">
    <meta name="keywords" content="blog,personal,responsive,kubernetes,linux,gitops,fluxcd,dotfiles,cluster,container">
    <meta name="generator" content="Hugo 0.101.0" />
    <title>
        
           
               How I Manage My Kubernetes Manifests Using Flux &vert; Budiman JoJo
           
        
    </title>
    <meta itemprop="name" content="How I Manage My Kubernetes Manifests Using Flux">
    <meta itemprop="description" content="How I Manage My Kubernetes Manifests Using Flux - Life Journey of My Geeky Needs.">
    <meta property="og:title" content="How I Manage My Kubernetes Manifests Using Flux">
    <meta property="og:description" content="How I Manage My Kubernetes Manifests Using Flux - Life Journey of My Geeky Needs.">
    <meta property="og:image" content="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?size=200">
    <meta property="og:url" content="https://budimanjojo.com/2021/10/20/how-i-manage-my-kubernetes-manifests-using-flux/">
    <meta property="og:site_name" content="Budiman JoJo">
    <meta property="og:type" content="article">

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">


    <script src="/modernizr-simple.js"></script>

    
    <link href="/2021/10/20/how-i-manage-my-kubernetes-manifests-using-flux/" rel="alternate" type="application/rss+xml" title="Budiman JoJo" />
    <link href="/2021/10/20/how-i-manage-my-kubernetes-manifests-using-flux/" rel="feed" type="application/rss+xml" title="Budiman JoJo" />
    

    
    <link rel="canonical" href="https://budimanjojo.com/2021/10/20/how-i-manage-my-kubernetes-manifests-using-flux/">
    

    <link rel="stylesheet" href="https://budimanjojo.com/theme.css">

    

    
        
    
</head>

<body class="bilberry-hugo-theme">

    
    <nav class="permanentTopNav">

    <div class="container">
        <ul class="topnav">
            
                
                    <li><a href="https://github.com/budimanjojo" target="_blank">Github</a></li>
                
            
                
                    <li><a href="/archive/" target="">Archive</a></li>
                
            
                
                    <li><a href="https://budimanjojo.com/page/about-budimanjojo/">About Me</a></li>
                
            
        </ul>

        
            <div id="search-box" class="search">
                <i class="fas fa-search"></i>
                <input id="search" type="text" placeholder="Search ...">
            </div>
        
    </div>
</nav>


    
    <header>

    <div class="container">
        <div class="logo">
            <a href="/" class="logo">
                
                    <img src="/avatar.png" alt="">
                

                <span class="overlay"><i class="fa fa-home"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title">
                <a href="/">
                    Budiman JoJo
                </a>
            </h3>

            
                <span class="subtitle">Life Journey of My Geeky Needs.</span>
            
        </div>

        

        
            <div class="toggler permanentTopNav">
        
                <i class="fa fa-bars" aria-hidden="true"></i>
            </div>
    </div>
</header>


    <div class="main container">
        
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="https://budimanjojo.com/2021/10/20/how-i-manage-my-kubernetes-manifests-using-flux/">
    <i class="fas fa-fw fa-pencil-alt"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h1 class="article-title">
        <a href="https://budimanjojo.com/2021/10/20/how-i-manage-my-kubernetes-manifests-using-flux/">
            How I Manage My Kubernetes Manifests Using Flux
        </a>
    </h1>

    <div class="meta">
        
            
                <span class="date moment">2021-10-20</span>
            
        

        
            
                <span class="readingTime">5 min read</span>
            
        

        
            <span class="categories">
                
                    
                    
                        <a href="https://budimanjojo.com/categories/kubernetes/">Kubernetes</a>
                    
                
                    
                    
                        <a href="https://budimanjojo.com/categories/linux/">Linux</a>
                    
                
                    
                    
                        <a href="https://budimanjojo.com/categories/self-hosted/">Self Hosted</a>
                    
                
            </span>
        

        
            <span class="author">
                
                
                    <a href="https://budimanjojo.com/author/budimanjojo/">budimanjojo</a>
                
            </span>
        
    </div>

    
        

        <p><img src="/wp-content/uploads/2021/10/home-cluster.png" alt="manage kubernetes manifests flux"></p>
<p>GitOps is currently the most popular way to manage your services. It’s sort of what DevOps is but with Git. To put it in a simple way, it is a practice where you manage everything through git. Whatever you have in your git repository is what your cluster current state is. Because GitOps is so popular there are a lot of new tools focusing on GitOps right now, and <a href="https://fluxcd.io/">Flux</a> is one of them. In this post I will give you a glance on how I manage my Kubernetes manifests using Flux.</p>
<h2 id="prerequisite">Prerequisite</h2>
<p>These are basically all you need to get started:</p>
<ul>
<li>A Kubernetes cluster already running</li>
<li>A git repository that your Kubernetes cluster can access, I use <a href="https://github.com">Github</a></li>
<li>Access to your Kubernetes cluster using kubectl</li>
</ul>
<h2 id="installing-flux-cli">Installing Flux CLI</h2>
<p>You will need to install Flux CLI In the machine that you can do kubectl commands into your Kubernetes cluster. Depending on your OS, you can get it from <a href="https://brew.sh/">Homebrew</a>, <a href="https://chocolatey.org/">Chocolatey</a>, <a href="https://aur.archlinux.org/">AUR</a>, <a href="https://gofi.sh/">GoFish</a>, or you can get it from their <a href="https://github.com/fluxcd/flux/releases">Github</a> repository using this one liner:</p>
<pre tabindex="0"><code>curl -s https://fluxcd.io/install.sh | sudo bash
</code></pre><h2 id="bootstrapping-to-github">Bootstrapping to Github</h2>
<p>To connect Flux with your Github repository, <a href="https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line">create a personal access token</a> and check all the permissions under “repo”. Export the generated token in a environment variable named GITHUB_TOKEN and run flux bootstrap command:</p>
<pre tabindex="0"><code>export GITHUB_TOKEN=&lt;your token&gt;
flux bootstrap github --owner your-github-username --repository repository-name --path path-to-flux --personal
</code></pre><p>Running the above command will create a Github repository if it doesn’t exist or push a commit if it already exists. You can use anything you want for the “–path” flag. Flux will create a directory called flux-system inside that path and it will contain all yaml files to get you started. Now, you can start putting kubernetes manifest files inside the directory where you specify the “–path” at.</p>
<p>Let’s clone the github repository into your machine now.</p>
<pre tabindex="0"><code>git clone https://github.com/your-github-username/repository-name
</code></pre><h2 id="creating-flux-kustomization">Creating Flux Kustomization</h2>
<p>Now, whatever you put inside the directory inside the repository will be deployed into your Kubernetes cluster. In my <a href="https://github.com/budimanjojo/home-cluster">repository</a>, I use <code>./cluster/base</code> as the path where I tell Flux where to look for manifests. There are two ways to deploy services with Flux, using <a href="https://kustomize.io/">kustomize</a> or <a href="https://helm.sh/">helm</a>. You don’t need to have kustomize or helm installed in your machine, Flux have both helm and kustomize controllers running in your cluster already. I don’t use Helm, so I will show you how I do this using kustomize. I do mine using Flux CLI like this:</p>
<pre tabindex="0"><code>cd home-cluster
flux create kustomization apps --interval 1m --path ./cluster/apps --prune true --source GitRepository/flux-system --export &gt; ./cluster/base/apps-kustomization.yaml
git add . &amp;&amp; git commit &#34;create apps kustomization&#34; &amp;&amp; git push
</code></pre><p>Please note that you don’t have to do the exact same thing as I put above, understanding about what the commands do is more important. These are what the above commands do:</p>
<ol>
<li>I change directory into home-cluster, which is my repository name. Replace it with the repository name you created in the bootstrap process.</li>
<li>I create a app-kustomization.yaml file using <code>flux create</code> CLI command:
<ul>
<li>the name of my kustomization is <code>apps</code></li>
<li>–interval 1m tells Flux to to synchronizing every 1 minute</li>
<li>–path ./cluster/apps tells Flux the directory to look for manifest files</li>
<li>–prune true tells Flux to delete resources in the directory if I delete them from Github</li>
<li>–source GitRepository/flux-system tells Flux to use this repository, flux-system GitRepository kind is automatically created by Flux when we do bootstrap command. This means you can create another source from another repository if you want to. You can use <code>flux create source</code> command to do this (not covered here)</li>
<li>–export tells Flux to export the output of this command which is basically a Kubernetes manifest</li>
<li>&gt; ./cluster/base/apps-kustomization.yaml pipe the output into a file</li>
</ul>
</li>
<li>I commit and push the changes into Github, so that Flux will see it.</li>
</ol>
<p>There are a lot more available flags that you can use in flux create kustomization command that I don’t show here, you can read them all <a href="https://fluxcd.io/docs/cmd/flux_create_kustomization/">here</a>.</p>
<h2 id="deploying-your-services-using-flux">Deploying Your Services Using Flux</h2>
<p>After creating Flux kustomization CRD using the step before, Flux will watch for the directory where you define with <code>--path</code> flag. Mine is in <code>./cluster/apps</code>. So let’s create an example service, let’s say I want to deploy <a href="https://www.adminer.org/">adminer</a>.</p>
<pre tabindex="0"><code>mkdir -p ./cluster/apps/adminer
cat ./cluster/apps/adminer/deployment.yaml &lt;&lt; EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: adminer
  labels:
    app.kubernetes.io/name: adminer
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: adminer
  template:
    metadata:
      labels:
        app.kubernetes.io/name: adminer
    spec:
      containers:
        - name: adminer
          image: adminer:4.8.1
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              protocol: TCP
              containerPort: 8080
EOF
cat ./cluster/apps/adminer/kustomization.yaml &lt;&lt; EOF
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: default
resources:
- deployment.yaml
EOF
git add . &amp;&amp; git commit -m &#34;deploy adminer&#34; &amp;&amp; git push
</code></pre><p>Again, you don’t have to follow whatever I do here. This post is more about explaining how it works rather than a tutorial, hence the title is how I manage my kubernetes manifests using Flux. What I did with the commands above are:</p>
<ol>
<li>Make a directory in <code>./cluster/apps/adminer</code>.</li>
<li>Create a deployment.yaml file which contains the Deployment kind of Kubernetes manifest inside the directory created above.</li>
<li>Create a kustomization.yaml file which contains Kustomization kind of Kubernetes manifest to tell Flux kustomization controller what file to sync with my Github repository.</li>
<li>I commit and push the changes into Github, so Flux will see it.</li>
</ol>
<p>Now, wait for 1m (depending on your –interval flag of your flux kustomization) and adminer will be deployed in your cluster. If you are impatient like me, you can use this command to force Flux to reconcile without waiting:</p>
<pre tabindex="0"><code>flux reconcile kustomization apps
</code></pre><h2 id="ending">Ending</h2>
<p>Thank you for reading my post, I hope you can learn something from this. Of course, there are a lot more that you can do with Flux. It has source, kuztomize, helm, notification, image controllers that you can make use of.</p>
<p>This is how I manage my Kubernetes manifests using Flux GitOps, tell me more about yours in the comment section.</p>
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    
                    
                    <a href="https://budimanjojo.com/tags/flux/">flux</a>
                    
                
                    
                    
                    <a href="https://budimanjojo.com/tags/gitops/">gitops</a>
                    
                
                    
                    
                    <a href="https://budimanjojo.com/tags/kubernetes/">kubernetes</a>
                    
                
                    
                    
                    <a href="https://budimanjojo.com/tags/linux/">linux</a>
                    
                
                    
                    
                    <a href="https://budimanjojo.com/tags/server/">server</a>
                    
                
            </div>
        </div>
    

    
</div>

</article>

        
    </div>

    
        <div id="comments-container">
            
            

            
    <script src="https://giscus.app/client.js"
        data-repo="budimanjojo/site"
        data-repo-id="R_kgDOH1yWAQ"
        data-category="General"
        data-category-id="DIC_kwDOH1yWAc4CQ6Px"
        data-mapping="title"
        data-reactions-enabled="1"
        data-emit-metadata=""
        data-theme="light_tritanopia"
        
            data-lang="en"
        
        crossorigin="anonymous"
        async>
    </script>
    <div id="giscus"></div>


            

        </div>
    

    </div>

    
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>Latest posts</strong>
            <ul>
                
                
                    <li>
                        <a href="https://budimanjojo.com/2021/12/13/managing-dotfiles-with-chezmoi/">Managing Dotfiles with chezmoi</a>
                    </li>
                
                    <li>
                        <a href="https://budimanjojo.com/2021/11/04/gitops-home-assistant-configurations/">How I GitOps Home Assistant Configurations</a>
                    </li>
                
                    <li>
                        <a href="https://budimanjojo.com/2021/10/28/kured-kubernetes/">Automating Kubernetes Nodes Reboot with Kured</a>
                    </li>
                
                    <li>
                        <a href="https://budimanjojo.com/2021/10/27/variable-substitution-in-flux-gitops/">Variable Substitution in Flux GitOps</a>
                    </li>
                
                    <li>
                        <a href="https://budimanjojo.com/2021/10/23/flux-secret-management-with-sops-age/">Flux Secret Management with SOPS age</a>
                    </li>
                
                    <li>
                        <a href="https://budimanjojo.com/2021/10/20/how-i-manage-my-kubernetes-manifests-using-flux/">How I Manage My Kubernetes Manifests Using Flux</a>
                    </li>
                
            </ul>
        </div>
        

        
        <div class="categories">
            <a href="/categories/"><strong>Categories</strong></a>
            <ul>
                
                <li>
                    <a href="/categories/linux">Linux
                        (9)</a>
                </li>
                
                <li>
                    <a href="/categories/self-hosted">Self hosted
                        (6)</a>
                </li>
                
                <li>
                    <a href="/categories/kubernetes">Kubernetes
                        (5)</a>
                </li>
                
                <li>
                    <a href="/categories/raspberry-pi">Raspberry pi
                        (4)</a>
                </li>
                
                <li>
                    <a href="/categories/terminal-stuffs">Terminal stuffs
                        (2)</a>
                </li>
                
                <li>
                    <a href="/categories/desktop-stuffs">Desktop stuffs
                        (1)</a>
                </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong>Social media</strong>

                
                <a href="https://github.com/budimanjojo" target="_blank"><i class="fab fa-github"></i></a>
                
                <a href="mailto:budiman@budimanjojo.com" target="_blank"><i class="fa fa-envelope"></i></a>
                
                <a href="https://www.youtube.com/channel/UCRDomXby1IfxWeTzB8xTOFA" target="_blank"><i class="fab fa-youtube"></i></a>
                
            </div>
            

            

            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/budimanjojo" target="_blank">
                &copy;
                
                2022
                
                by budimanjojo
            </a>
            
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme"
                target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


    

    


    <script src="https://budimanjojo.com/theme.js"></script>

    
    
    

    
    <div id="activate-algolia-search" class="hidden">
  <input type="hidden" id="algolia-search-appId" value="72C1FEBFMX">
  <input type="hidden" id="algolia-search-apiKey" value="f86a032ec932c5020e3a63404a6d937e">
  <input type="hidden" id="algolia-search-indexName" value="budimanjojo_com">
  <input type="hidden" id="algolia-search-noSearchResults" value="Nothing found.">

  
</div>

    
</body>

</html>
