<!DOCTYPE html>


  
<html itemscope itemtype="https://schema.org/WebPage" class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="siteBaseUrl" content="https://budimanjojo.com">
    <meta name="author" content="budimanjojo">
    <meta name="description" content="Life Journey of My Geeky Needs.">
    <meta name="keywords" content="blog,personal,responsive,kubernetes,linux,gitops,fluxcd,dotfiles,cluster,container">
    <meta name="generator" content="Hugo 0.101.0" />
    <title>
        
           
               Automating Kubernetes Nodes Reboot with Kured &vert; Budiman JoJo
           
        
    </title>
    <meta itemprop="name" content="Automating Kubernetes Nodes Reboot with Kured">
    <meta itemprop="description" content="Automating Kubernetes Nodes Reboot with Kured - Life Journey of My Geeky Needs.">
    <meta property="og:title" content="Automating Kubernetes Nodes Reboot with Kured">
    <meta property="og:description" content="Automating Kubernetes Nodes Reboot with Kured - Life Journey of My Geeky Needs.">
    <meta property="og:image" content="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?size=200">
    <meta property="og:url" content="https://budimanjojo.com/2021/10/28/kured-kubernetes/">
    <meta property="og:site_name" content="Budiman JoJo">
    <meta property="og:type" content="article">

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">


    <script src="/modernizr-simple.js"></script>

    
    <link href="/2021/10/28/kured-kubernetes/" rel="alternate" type="application/rss+xml" title="Budiman JoJo" />
    <link href="/2021/10/28/kured-kubernetes/" rel="feed" type="application/rss+xml" title="Budiman JoJo" />
    

    
    <link rel="canonical" href="https://budimanjojo.com/2021/10/28/kured-kubernetes/">
    

    <link rel="stylesheet" href="https://budimanjojo.com/theme.css">

    

    
        
    
</head>

<body class="bilberry-hugo-theme">

    
    <nav class="permanentTopNav">

    <div class="container">
        <ul class="topnav">
            
                
                    <li><a href="https://github.com/budimanjojo" target="_blank">Github</a></li>
                
            
                
                    <li><a href="/archive/" target="">Archive</a></li>
                
            
                
                    <li><a href="https://budimanjojo.com/page/about-budimanjojo/">About Me</a></li>
                
            
        </ul>

        
            <div id="search-box" class="search">
                <i class="fas fa-search"></i>
                <input id="search" type="text" placeholder="Search ...">
            </div>
        
    </div>
</nav>


    
    <header>

    <div class="container">
        <div class="logo">
            <a href="/" class="logo">
                
                    <img src="/avatar.png" alt="">
                

                <span class="overlay"><i class="fa fa-home"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title">
                <a href="/">
                    Budiman JoJo
                </a>
            </h3>

            
                <span class="subtitle">Life Journey of My Geeky Needs.</span>
            
        </div>

        

        
            <div class="toggler permanentTopNav">
        
                <i class="fa fa-bars" aria-hidden="true"></i>
            </div>
    </div>
</header>


    <div class="main container">
        
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="https://budimanjojo.com/2021/10/28/kured-kubernetes/">
    <i class="fas fa-fw fa-pencil-alt"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h1 class="article-title">
        <a href="https://budimanjojo.com/2021/10/28/kured-kubernetes/">
            Automating Kubernetes Nodes Reboot with Kured
        </a>
    </h1>

    <div class="meta">
        
            
                <span class="date moment">2021-10-28</span>
            
        

        
            
                <span class="readingTime">3 min read</span>
            
        

        
            <span class="categories">
                
                    
                    
                        <a href="https://budimanjojo.com/categories/kubernetes/">Kubernetes</a>
                    
                
                    
                    
                        <a href="https://budimanjojo.com/categories/linux/">Linux</a>
                    
                
                    
                    
                        <a href="https://budimanjojo.com/categories/self-hosted/">Self Hosted</a>
                    
                
            </span>
        

        
            <span class="author">
                
                
                    <a href="https://budimanjojo.com/author/budimanjojo/">budimanjojo</a>
                
            </span>
        
    </div>

    
        

        <p><img src="/wp-content/uploads/2021/10/auto-reboot.png" alt="kured-kubernetes"></p>
<p>Having an up-to-date Kubernetes node is important, especially security updates. Sometimes an update requires a reboot to take effect, and you don’t want to keep checking them manually. In this post, I will share about how I automate my Kubernetes nodes to reboot when necessary using <a href="https://github.com/weaveworks/kured">Kured</a>.</p>
<h2 id="linux-distro-specific">Linux Distro Specific</h2>
<p>Before doing the actual setting up process, every Linux distribution has its own way to decide whether a reboot is required or not. As I’m using Ubuntu server edition as my Kubernetes nodes distribution, I will show you how to do this in Ubuntu (it should works with Debian as well). If you are using other server oriented distribution i.e CentOS, RHEL, OpenSUSE Leap, CoreOS, etc they will have their own way of doing automatic updates and notify you to reboot. If you are using desktop Linux distributions like Arch Linux (which I used to do), you might need to create your own script for that.</p>
<h2 id="enabling-unattended-upgrade-in-ubuntu">Enabling Unattended Upgrade in Ubuntu</h2>
<p>Like I mentioned before, I will show you how I do it using Ubuntu as this is where my Kubernetes nodes live. It is really simple to enable auto update in Ubuntu server. if you have a lot of nodes to configure, doing this using <a href="https://www.ansible.com/">Ansible</a> will be so much easier.</p>
<ol>
<li>Make sure the required packages are installed and enabled (it’s installed and enabled by default in Ubuntu 20.04 server edition)</li>
</ol>
<pre tabindex="0"><code>sudo apt install unattended-upgrades update-notifier-common &amp;&amp; sudo systemctl enable --now unattended-upgrades
</code></pre><ol start="2">
<li>Configure unattended-upgrades, edit the file <code>/etc/apt/apt.conf.d/50unattended-upgrades</code>. The default in 20.04 is already pre-configured with security updates enabled, I set mine to enable all repositories though.</li>
</ol>
<pre tabindex="0"><code>$ cat /etc/apt/apt.conf.d/50unattended-upgrades

// Automatically upgrade packages from these (origin:archive) pairs
//
// Note that in Ubuntu security updates may pull in new dependencies
// from non-security sources (e.g. chromium). By allowing the release
// pocket these get automatically pulled in.
Unattended-Upgrade::Allowed-Origins {
        &#34;${distro_id}:${distro_codename}&#34;;
        &#34;${distro_id}:${distro_codename}-security&#34;;
        // Extended Security Maintenance; doesn&#39;t necessarily exist for
        // every release and this system may not have it installed, but if
        // available, the policy for updates is such that unattended-upgrades
        // should also install from here by default.
        &#34;${distro_id}ESMApps:${distro_codename}-apps-security&#34;;
        &#34;${distro_id}ESM:${distro_codename}-infra-security&#34;;
        &#34;${distro_id}:${distro_codename}-updates&#34;;
        &#34;${distro_id}:${distro_codename}-proposed&#34;;
        &#34;${distro_id}:${distro_codename}-backports&#34;;
};
</code></pre><ol start="3">
<li>Lastly, edit the file <code>/etc/apt/apt.conf.d/20auto-upgrades</code> and make sure the first 2 lines below are set to “<code>1</code>” and alternatively I also added the third line to do auto-clean every 7 days.</li>
</ol>
<pre tabindex="0"><code>$ cat /etc/apt/apt.conf.d/20auto-upgrades

APT::Periodic::Update-Package-Lists &#34;1&#34;;
APT::Periodic::Unattended-Upgrade &#34;1&#34;;
APT::Periodic::AutocleanInterval &#34;7&#34;;
</code></pre><h2 id="deploying-kured">Deploying Kured</h2>
<p>Once we already have our Ubuntu node configured like above, now we have to deploy Kured in our Kubernetes cluster. Deploying Kured can be done using their <a href="https://github.com/weaveworks/kured/tree/main/charts/kured">Helm chart</a> or you can use <a href="https://fluxcd.io/">Flux</a> and <a href="https://kustomize.io/">Kustomize</a> like I do <a href="https://github.com/budimanjojo/home-cluster/tree/main/cluster/apps/kured">here</a>. I recommend you to read my post about <a href="https://budimanjojo.com/2021/10/20/how-i-manage-my-kubernetes-manifests-using-flux/">how I manage my Kubernetes cluster using Flux</a>.</p>
<h2 id="configuring-kured">Configuring Kured</h2>
<p>This step can be done at deploy time or after deploying. There are a lot of flags you can configure which you can look at <a href="https://github.com/weaveworks/kured#configuration">here</a>. But if you are using Ubuntu like me, make sure that <code>--reboot-sentinel</code> is set to <code>/var/run/reboot-required</code>. You can also set up notification with <a href="https://containrrr.dev/shoutrrr/v0.5/services/overview/">shoutrrr</a> formatting using the <code>--notify-url</code> flag.</p>
<h2 id="testing">Testing</h2>
<p>Waiting for your Kubernetes node to tell Kured it’s time to reboot might take you forever. You can test whether it’s working by triggering <code>--reboot-sentinel</code> or <code>--reboot-sentinel-command</code> flag you have set. In Ubuntu, you can login into one of your nodes and create an empty file in <code>/var/run/reboot-required</code>:</p>
<pre tabindex="0"><code>sudo touch /var/run/reboot-required
</code></pre><p>You can set the –period to a shorter duration (default is 1 hour) to have Kured try to check whether reboot is required or not. I have mine set to <code>--period 5m</code> so I don’t have to wait for too long.</p>
<h2 id="ending">Ending</h2>
<p>Thank you for reading my post! Hopefully this post can help you in some ways. I would be very happy if you can leave me some comments below.</p>
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    
                    
                    <a href="https://budimanjojo.com/tags/gitops/">gitops</a>
                    
                
                    
                    
                    <a href="https://budimanjojo.com/tags/kubernetes/">kubernetes</a>
                    
                
                    
                    
                    <a href="https://budimanjojo.com/tags/kured/">kured</a>
                    
                
                    
                    
                    <a href="https://budimanjojo.com/tags/linux/">linux</a>
                    
                
            </div>
        </div>
    

    
</div>

</article>

        
    </div>

    
        <div id="comments-container">
            
            

            
    <script src="https://giscus.app/client.js"
        data-repo="budimanjojo/site"
        data-repo-id="R_kgDOH1yWAQ"
        data-category="General"
        data-category-id="DIC_kwDOH1yWAc4CQ6Px"
        data-mapping="title"
        data-reactions-enabled="1"
        data-emit-metadata=""
        data-theme="light_tritanopia"
        
            data-lang="en"
        
        crossorigin="anonymous"
        async>
    </script>
    <div id="giscus"></div>


            

        </div>
    

    </div>

    
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>Latest posts</strong>
            <ul>
                
                
                    <li>
                        <a href="https://budimanjojo.com/2021/12/13/managing-dotfiles-with-chezmoi/">Managing Dotfiles with chezmoi</a>
                    </li>
                
                    <li>
                        <a href="https://budimanjojo.com/2021/11/04/gitops-home-assistant-configurations/">How I GitOps Home Assistant Configurations</a>
                    </li>
                
                    <li>
                        <a href="https://budimanjojo.com/2021/10/28/kured-kubernetes/">Automating Kubernetes Nodes Reboot with Kured</a>
                    </li>
                
                    <li>
                        <a href="https://budimanjojo.com/2021/10/27/variable-substitution-in-flux-gitops/">Variable Substitution in Flux GitOps</a>
                    </li>
                
                    <li>
                        <a href="https://budimanjojo.com/2021/10/23/flux-secret-management-with-sops-age/">Flux Secret Management with SOPS age</a>
                    </li>
                
                    <li>
                        <a href="https://budimanjojo.com/2021/10/20/how-i-manage-my-kubernetes-manifests-using-flux/">How I Manage My Kubernetes Manifests Using Flux</a>
                    </li>
                
            </ul>
        </div>
        

        
        <div class="categories">
            <a href="/categories/"><strong>Categories</strong></a>
            <ul>
                
                <li>
                    <a href="/categories/linux">Linux
                        (9)</a>
                </li>
                
                <li>
                    <a href="/categories/self-hosted">Self hosted
                        (6)</a>
                </li>
                
                <li>
                    <a href="/categories/kubernetes">Kubernetes
                        (5)</a>
                </li>
                
                <li>
                    <a href="/categories/raspberry-pi">Raspberry pi
                        (4)</a>
                </li>
                
                <li>
                    <a href="/categories/terminal-stuffs">Terminal stuffs
                        (2)</a>
                </li>
                
                <li>
                    <a href="/categories/desktop-stuffs">Desktop stuffs
                        (1)</a>
                </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong>Social media</strong>

                
                <a href="https://github.com/budimanjojo" target="_blank"><i class="fab fa-github"></i></a>
                
                <a href="mailto:budiman@budimanjojo.com" target="_blank"><i class="fa fa-envelope"></i></a>
                
                <a href="https://www.youtube.com/channel/UCRDomXby1IfxWeTzB8xTOFA" target="_blank"><i class="fab fa-youtube"></i></a>
                
            </div>
            

            

            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/budimanjojo" target="_blank">
                &copy;
                
                2022
                
                by budimanjojo
            </a>
            
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme"
                target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


    

    


    <script src="https://budimanjojo.com/theme.js"></script>

    
    
    

    
    <div id="activate-algolia-search" class="hidden">
  <input type="hidden" id="algolia-search-appId" value="72C1FEBFMX">
  <input type="hidden" id="algolia-search-apiKey" value="f86a032ec932c5020e3a63404a6d937e">
  <input type="hidden" id="algolia-search-indexName" value="budimanjojo_com">
  <input type="hidden" id="algolia-search-noSearchResults" value="Nothing found.">

  
</div>

    
</body>

</html>
